import discord
from discord.ext import commands
import re
import os
from collections import defaultdict
from dotenv import load_dotenv
from colorama import Fore, Style, init
from datetime import datetime

init(autoreset=True)

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
load_dotenv()
TOKEN = os.getenv('TOKEN')
logo_url =""

# Define intents
intents = discord.Intents.default()
intents.members = True
intents.message_content = True
intents.guilds = True
intents.messages = True

bot = commands.Bot(command_prefix='$', intents=intents, help_command=None)

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ© ---
SPAM_THRESHOLD = 5
SPAM_TIME = 7
BAD_WORDS = ['ÙƒÙ„Ù…Ø©Ø³ÙŠØ¦Ø©1', 'ÙƒÙ„Ù…Ø©Ø³ÙŠØ¦Ø©2', 'badword']
ALLOWED_LINKS = ['discord.com', 'youtube.com']
user_message_times = defaultdict(list)

# --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
def rainbow_text(text):
    colors = [Fore.RED, Fore.YELLOW, Fore.GREEN, Fore.CYAN, Fore.BLUE, Fore.MAGENTA]
    result = ""
    for i, char in enumerate(text):
        result += colors[i % len(colors)] + char
    return result + Style.RESET_ALL

async def log_event(guild: discord.Guild, log_text: str, embed: discord.Embed, log_type="INFO"):
    # Ù„ÙˆÙ‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙÙŠØ©
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    emoji = {"BAN": "ğŸš«", "KICK": "âš ï¸", "MUTE": "ğŸ”‡", "UNMUTE": "ğŸ”Š", "UNBAN": "ğŸ”“", "ROLE": "ğŸ­", "SPAM": "ğŸš¨", "LINK": "ğŸ”—", "BAD": "â—ï¸", "INFO": "â„¹ï¸"}.get(log_type, "â„¹ï¸")
    print(f"{Fore.CYAN}{emoji} [{now}] {log_text}{Style.RESET_ALL}")

    # Ù„ÙˆÙ‚ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯
    channel = discord.utils.get(guild.text_channels, name='ğŸ”¦ãƒ»staff-log')
    if channel:
        await channel.send(embed=embed)

def has_special_role():
    async def predicate(ctx):
        role_id = 1396238064669687811
        return any(role.id == role_id for role in ctx.author.roles)
    return commands.check(predicate)

# --- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨ÙˆØª ---
@bot.event
async def on_ready():
    print(rainbow_text("âœ¨ğŸ‘‹ Welcome back Dune Raiders Developers! ğŸ‘¨â€ğŸ’»âš¡"))
    print(f"{Fore.CYAN}â„¹ï¸ [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] DuneRaiders is Ready to protect your server{Style.RESET_ALL}")
    
    await bot.change_presence(activity=discord.Streaming(name="DuneRaiders", url="https://twitch.tv/DuneRaiders "))
    
    embed = discord.Embed(title="ğŸ›¡ï¸ DuneRaiders is Ready to protect your server!", description=f"Ø§Ù„Ø¨ÙˆØª Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!\nØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³Ù…: **{bot.user}**", color=discord.Color.blue(), timestamp=discord.utils.utcnow())
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=bot.user.avatar.url if bot.user.avatar else discord.Embed.Empty)
    
    for guild in bot.guilds:
        log_channel = discord.utils.get(guild.text_channels, name='ğŸ”¦ãƒ»staff-log')
        if log_channel:
            await log_channel.send(embed=embed)

@bot.event
async def on_message(message):
    if message.author.bot:
        return
    await bot.process_commands(message)

# --- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---
@bot.command(name="help", description="Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø±")
async def help(ctx):
    embed = discord.Embed(title="ğŸ› ï¸ Ø£ÙˆØ§Ù…Ø± DuneRaiders", description="Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:", color=discord.Color.teal(), timestamp=discord.utils.utcnow())
    embed.add_field(name="$ban", value="Ø­Ø¸Ø± Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$kick", value="Ø·Ø±Ø¯ Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$mute", value="ÙƒØªÙ… Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$unmute", value="ÙÙƒ ÙƒØªÙ… Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$unban", value="ÙÙƒ Ø­Ø¸Ø± Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$role", value="Ø¥Ø¹Ø·Ø§Ø¡ Ø±ÙˆÙ„ Ù„Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$removerole", value="Ø¥Ø²Ø§Ù„Ø© Ø±ÙˆÙ„ Ù…Ù† Ø¹Ø¶Ùˆ", inline=False)
    embed.add_field(name="$countroles", value="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±ØªØ¨", inline=False)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    await ctx.send(embed=embed)

@bot.command(name="ban")
@has_special_role()
async def ban(ctx, member: discord.Member, *, reason: str = None):
    await member.ban(reason=reason)
    
    embed = discord.Embed(
        title="ğŸš« ØªÙ… Ø­Ø¸Ø± Ø¹Ø¶Ùˆ",
        description=f"ØªÙ… Ø­Ø¸Ø± {member.mention} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø¨Ù„ {ctx.author.mention}.",
        color=discord.Color.red(),
        timestamp=discord.utils.utcnow()
    )
    if reason:
        embed.add_field(name="Ø§Ù„Ø³Ø¨Ø¨", value=reason)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"ØªÙ… Ø­Ø¸Ø± {member} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "BAN")

@bot.command(name="kick")
@has_special_role()
async def kick(ctx, member: discord.Member, *, reason: str = None):
    await member.kick(reason=reason)
    
    embed = discord.Embed(
        title="âš ï¸ ØªÙ… Ø·Ø±Ø¯ Ø¹Ø¶Ùˆ",
        description=f"ØªÙ… Ø·Ø±Ø¯ {member.mention} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø¨Ù„ {ctx.author.mention}.",
        color=discord.Color.orange(),
        timestamp=discord.utils.utcnow()
    )
    if reason:
        embed.add_field(name="Ø§Ù„Ø³Ø¨Ø¨", value=reason)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"ØªÙ… Ø·Ø±Ø¯ {member} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "KICK")

@bot.command(name="mute")
@has_special_role()
async def mute(ctx, member: discord.Member, *, reason: str = None):
    muted_role = discord.utils.get(ctx.guild.roles, name="Muted")
    if not muted_role:
        muted_role = await ctx.guild.create_role(name="Muted")
        for channel in ctx.guild.channels:
            await channel.set_permissions(muted_role, speak=False, send_messages=False)
    
    await member.add_roles(muted_role, reason=reason)
    
    embed = discord.Embed(
        title="ğŸ”‡ ØªÙ… ÙƒØªÙ… Ø¹Ø¶Ùˆ",
        description=f"ØªÙ… ÙƒØªÙ… {member.mention} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø¨Ù„ {ctx.author.mention}.",
        color=discord.Color.orange(),
        timestamp=discord.utils.utcnow()
    )
    if reason:
        embed.add_field(name="Ø§Ù„Ø³Ø¨Ø¨", value=reason)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"ØªÙ… ÙƒØªÙ… {member} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "MUTE")

@bot.command(name="unmute")
@has_special_role()
async def unmute(ctx, member: discord.Member):
    muted_role = discord.utils.get(ctx.guild.roles, name="Muted")
    if muted_role in member.roles:
        await member.remove_roles(muted_role)
        
        embed = discord.Embed(
            title="ğŸ”Š ØªÙ… ÙÙƒ ÙƒØªÙ… Ø¹Ø¶Ùˆ",
            description=f"ØªÙ… ÙÙƒ ÙƒØªÙ… {member.mention} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø¨Ù„ {ctx.author.mention}.",
            color=discord.Color.green(),
            timestamp=discord.utils.utcnow()
        )
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        
        await ctx.send(embed=embed)
        await log_event(ctx.guild, f"ØªÙ… ÙÙƒ ÙƒØªÙ… {member} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "UNMUTE")
    else:
        await ctx.send("Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙƒØªÙˆÙ…!")

@bot.command(name="unban")
@has_special_role()
async def unban(ctx, user_id: str):
    try:
        user = await bot.fetch_user(int(user_id))
        await ctx.guild.unban(user)
        
        embed = discord.Embed(
            title="ğŸ”“ ØªÙ… ÙÙƒ Ø­Ø¸Ø± Ø¹Ø¶Ùˆ",
            description=f"ØªÙ… ÙÙƒ Ø­Ø¸Ø± {user.mention} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø¨Ù„ {ctx.author.mention}.",
            color=discord.Color.green(),
            timestamp=discord.utils.utcnow()
        )
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        
        await ctx.send(embed=embed)
        await log_event(ctx.guild, f"ØªÙ… ÙÙƒ Ø­Ø¸Ø± {user} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "UNBAN")
    except ValueError:
        await ctx.send("Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­!")
    except discord.NotFound:
        await ctx.send("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ!")

@bot.command(name="role")
@has_special_role()
async def role(ctx, member: discord.Member, role: discord.Role):
    await member.add_roles(role)
    
    embed = discord.Embed(
        title="ğŸ­ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±ØªØ¨Ø©",
        description=f"ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ Ø±ØªØ¨Ø© {role.mention} Ù„Ù€ {member.mention} Ø¨Ù†Ø¬Ø§Ø­.",
        color=discord.Color.blue(),
        timestamp=discord.utils.utcnow()
    )
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ Ø±ØªØ¨Ø© {role} Ù„Ù€ {member} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "ROLE")

@bot.command(name="removerole")
@has_special_role()
async def removerole(ctx, member: discord.Member, role: discord.Role):
    if role in member.roles:
        await member.remove_roles(role)
        
        embed = discord.Embed(
            title="ğŸ­ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±ØªØ¨Ø©",
            description=f"ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±ØªØ¨Ø© {role.mention} Ù…Ù† {member.mention} Ø¨Ù†Ø¬Ø§Ø­.",
            color=discord.Color.blue(),
            timestamp=discord.utils.utcnow()
        )
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        
        await ctx.send(embed=embed)
        await log_event(ctx.guild, f"ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø±ØªØ¨Ø© {role} Ù…Ù† {member} Ù…Ù† Ù‚Ø¨Ù„ {ctx.author}", embed, "ROLE")
    else:
        await ctx.send("Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø±ØªØ¨Ø©!")

@bot.command(name="countroles")
@has_special_role()
async def countroles(ctx):
    gamer_role = discord.utils.get(ctx.guild.roles, id=)
    streamer_role = discord.utils.get(ctx.guild.roles, id=)
    staff_role = discord.utils.get(ctx.guild.roles, id=)
    
    gamer_count = len(gamer_role.members) if gamer_role else 0
    streamer_count = len(streamer_role.members) if streamer_role else 0
    staff_count = len(staff_role.members) if staff_role else 0
    
    embed = discord.Embed(
        title="ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±ØªØ¨",
        color=discord.Color.blue(),
        timestamp=discord.utils.utcnow()
    )
    embed.add_field(name="", value=f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: {gamer_count}", inline=False)
    embed.add_field(name="", value=f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: {streamer_count}", inline=False)
    embed.add_field(name="", value=f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: {staff_count}", inline=False)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by 4.9v", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)

# --- Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ---
@bot.event
async def on_command_error(ctx, error):
    if isinstance(error, commands.CheckFailure):
        embed = discord.Embed(title="ğŸ”’ ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶", description="Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.", color=discord.Color.red(), timestamp=discord.utils.utcnow())
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        await ctx.send(embed=embed)
    else:
        await ctx.send("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹!")
        print(f"An error occurred: {error}")

# --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ---
if __name__ == '__main__':
    bot.run(TOKEN)

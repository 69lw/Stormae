import discord
from discord.ext import commands
import re
import os
from collections import defaultdict
from dotenv import load_dotenv
from colorama import Fore, Style, init
from datetime import datetime

init(autoreset=True)

# --- إعدادات البوت الأساسية ---
load_dotenv()
TOKEN = os.getenv('TOKEN')
logo_url =""

# Define intents
intents = discord.Intents.default()
intents.members = True
intents.message_content = True
intents.guilds = True
intents.messages = True

bot = commands.Bot(command_prefix='$', intents=intents, help_command=None)

# --- إعدادات الحماية ---
SPAM_THRESHOLD = 5
SPAM_TIME = 7
BAD_WORDS = ['كلمةسيئة1', 'كلمةسيئة2', 'badword']
ALLOWED_LINKS = ['discord.com', 'youtube.com']
user_message_times = defaultdict(list)

# --- دوال مساعدة ---
def rainbow_text(text):
    colors = [Fore.RED, Fore.YELLOW, Fore.GREEN, Fore.CYAN, Fore.BLUE, Fore.MAGENTA]
    result = ""
    for i, char in enumerate(text):
        result += colors[i % len(colors)] + char
    return result + Style.RESET_ALL

async def log_event(guild: discord.Guild, log_text: str, embed: discord.Embed, log_type="INFO"):
    # لوق في الطرفية
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    emoji = {"BAN": "🚫", "KICK": "⚠️", "MUTE": "🔇", "UNMUTE": "🔊", "UNBAN": "🔓", "ROLE": "🎭", "SPAM": "🚨", "LINK": "🔗", "BAD": "❗️", "INFO": "ℹ️"}.get(log_type, "ℹ️")
    print(f"{Fore.CYAN}{emoji} [{now}] {log_text}{Style.RESET_ALL}")

    # لوق في قناة الديسكورد
    channel = discord.utils.get(guild.text_channels, name='🔦・staff-log')
    if channel:
        await channel.send(embed=embed)

def has_special_role():
    async def predicate(ctx):
        role_id = 1396238064669687811
        return any(role.id == role_id for role in ctx.author.roles)
    return commands.check(predicate)

# --- أحداث البوت ---
@bot.event
async def on_ready():
    print(rainbow_text("✨👋 Welcome back Dune Raiders Developers! 👨‍💻⚡"))
    print(f"{Fore.CYAN}ℹ️ [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] DuneRaiders is Ready to protect your server{Style.RESET_ALL}")
    
    await bot.change_presence(activity=discord.Streaming(name="DuneRaiders", url="https://twitch.tv/DuneRaiders "))
    
    embed = discord.Embed(title="🛡️ DuneRaiders is Ready to protect your server!", description=f"البوت جاهز للعمل!\nتم تسجيل الدخول باسم: **{bot.user}**", color=discord.Color.blue(), timestamp=discord.utils.utcnow())
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=bot.user.avatar.url if bot.user.avatar else discord.Embed.Empty)
    
    for guild in bot.guilds:
        log_channel = discord.utils.get(guild.text_channels, name='🔦・staff-log')
        if log_channel:
            await log_channel.send(embed=embed)

@bot.event
async def on_message(message):
    if message.author.bot:
        return
    await bot.process_commands(message)

# --- أوامر البوت ---
@bot.command(name="help", description="عرض قائمة بجميع الأوامر")
async def help(ctx):
    embed = discord.Embed(title="🛠️ أوامر DuneRaiders", description="قائمة بجميع الأوامر المتاحة:", color=discord.Color.teal(), timestamp=discord.utils.utcnow())
    embed.add_field(name="$ban", value="حظر عضو", inline=False)
    embed.add_field(name="$kick", value="طرد عضو", inline=False)
    embed.add_field(name="$mute", value="كتم عضو", inline=False)
    embed.add_field(name="$unmute", value="فك كتم عضو", inline=False)
    embed.add_field(name="$unban", value="فك حظر عضو", inline=False)
    embed.add_field(name="$role", value="إعطاء رول لعضو", inline=False)
    embed.add_field(name="$removerole", value="إزالة رول من عضو", inline=False)
    embed.add_field(name="$countroles", value="إحصائيات الرتب", inline=False)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    await ctx.send(embed=embed)

@bot.command(name="ban")
@has_special_role()
async def ban(ctx, member: discord.Member, *, reason: str = None):
    await member.ban(reason=reason)
    
    embed = discord.Embed(
        title="🚫 تم حظر عضو",
        description=f"تم حظر {member.mention} بنجاح من قبل {ctx.author.mention}.",
        color=discord.Color.red(),
        timestamp=discord.utils.utcnow()
    )
    if reason:
        embed.add_field(name="السبب", value=reason)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"تم حظر {member} من قبل {ctx.author}", embed, "BAN")

@bot.command(name="kick")
@has_special_role()
async def kick(ctx, member: discord.Member, *, reason: str = None):
    await member.kick(reason=reason)
    
    embed = discord.Embed(
        title="⚠️ تم طرد عضو",
        description=f"تم طرد {member.mention} بنجاح من قبل {ctx.author.mention}.",
        color=discord.Color.orange(),
        timestamp=discord.utils.utcnow()
    )
    if reason:
        embed.add_field(name="السبب", value=reason)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"تم طرد {member} من قبل {ctx.author}", embed, "KICK")

@bot.command(name="mute")
@has_special_role()
async def mute(ctx, member: discord.Member, *, reason: str = None):
    muted_role = discord.utils.get(ctx.guild.roles, name="Muted")
    if not muted_role:
        muted_role = await ctx.guild.create_role(name="Muted")
        for channel in ctx.guild.channels:
            await channel.set_permissions(muted_role, speak=False, send_messages=False)
    
    await member.add_roles(muted_role, reason=reason)
    
    embed = discord.Embed(
        title="🔇 تم كتم عضو",
        description=f"تم كتم {member.mention} بنجاح من قبل {ctx.author.mention}.",
        color=discord.Color.orange(),
        timestamp=discord.utils.utcnow()
    )
    if reason:
        embed.add_field(name="السبب", value=reason)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"تم كتم {member} من قبل {ctx.author}", embed, "MUTE")

@bot.command(name="unmute")
@has_special_role()
async def unmute(ctx, member: discord.Member):
    muted_role = discord.utils.get(ctx.guild.roles, name="Muted")
    if muted_role in member.roles:
        await member.remove_roles(muted_role)
        
        embed = discord.Embed(
            title="🔊 تم فك كتم عضو",
            description=f"تم فك كتم {member.mention} بنجاح من قبل {ctx.author.mention}.",
            color=discord.Color.green(),
            timestamp=discord.utils.utcnow()
        )
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        
        await ctx.send(embed=embed)
        await log_event(ctx.guild, f"تم فك كتم {member} من قبل {ctx.author}", embed, "UNMUTE")
    else:
        await ctx.send("هذا العضو غير مكتوم!")

@bot.command(name="unban")
@has_special_role()
async def unban(ctx, user_id: str):
    try:
        user = await bot.fetch_user(int(user_id))
        await ctx.guild.unban(user)
        
        embed = discord.Embed(
            title="🔓 تم فك حظر عضو",
            description=f"تم فك حظر {user.mention} بنجاح من قبل {ctx.author.mention}.",
            color=discord.Color.green(),
            timestamp=discord.utils.utcnow()
        )
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        
        await ctx.send(embed=embed)
        await log_event(ctx.guild, f"تم فك حظر {user} من قبل {ctx.author}", embed, "UNBAN")
    except ValueError:
        await ctx.send("معرف العضو غير صحيح!")
    except discord.NotFound:
        await ctx.send("لم يتم العثور على العضو!")

@bot.command(name="role")
@has_special_role()
async def role(ctx, member: discord.Member, role: discord.Role):
    await member.add_roles(role)
    
    embed = discord.Embed(
        title="🎭 تم إضافة رتبة",
        description=f"تم إعطاء رتبة {role.mention} لـ {member.mention} بنجاح.",
        color=discord.Color.blue(),
        timestamp=discord.utils.utcnow()
    )
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)
    await log_event(ctx.guild, f"تم إعطاء رتبة {role} لـ {member} من قبل {ctx.author}", embed, "ROLE")

@bot.command(name="removerole")
@has_special_role()
async def removerole(ctx, member: discord.Member, role: discord.Role):
    if role in member.roles:
        await member.remove_roles(role)
        
        embed = discord.Embed(
            title="🎭 تم إزالة رتبة",
            description=f"تم إزالة رتبة {role.mention} من {member.mention} بنجاح.",
            color=discord.Color.blue(),
            timestamp=discord.utils.utcnow()
        )
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        
        await ctx.send(embed=embed)
        await log_event(ctx.guild, f"تم إزالة رتبة {role} من {member} من قبل {ctx.author}", embed, "ROLE")
    else:
        await ctx.send("هذا العضو لا يملك هذه الرتبة!")

@bot.command(name="countroles")
@has_special_role()
async def countroles(ctx):
    gamer_role = discord.utils.get(ctx.guild.roles, id=)
    streamer_role = discord.utils.get(ctx.guild.roles, id=)
    staff_role = discord.utils.get(ctx.guild.roles, id=)
    
    gamer_count = len(gamer_role.members) if gamer_role else 0
    streamer_count = len(streamer_role.members) if streamer_role else 0
    staff_count = len(staff_role.members) if staff_role else 0
    
    embed = discord.Embed(
        title="📊 إحصائيات الرتب",
        color=discord.Color.blue(),
        timestamp=discord.utils.utcnow()
    )
    embed.add_field(name="", value=f"عدد الأعضاء: {gamer_count}", inline=False)
    embed.add_field(name="", value=f"عدد الأعضاء: {streamer_count}", inline=False)
    embed.add_field(name="", value=f"عدد الأعضاء: {staff_count}", inline=False)
    embed.set_image(url=logo_url)
    embed.set_footer(text="SecBot | Powered by 4.9v", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
    
    await ctx.send(embed=embed)

# --- معالج الأخطاء ---
@bot.event
async def on_command_error(ctx, error):
    if isinstance(error, commands.CheckFailure):
        embed = discord.Embed(title="🔒 وصول مرفوض", description="ليس لديك الصلاحية المطلوبة لاستخدام هذا الأمر.", color=discord.Color.red(), timestamp=discord.utils.utcnow())
        embed.set_image(url=logo_url)
        embed.set_footer(text="SecBot | Powered by Advanced AI", icon_url=ctx.bot.user.avatar.url if ctx.bot.user.avatar else discord.Embed.Empty)
        await ctx.send(embed=embed)
    else:
        await ctx.send("حدث خطأ غير متوقع!")
        print(f"An error occurred: {error}")

# --- تشغيل البوت ---
if __name__ == '__main__':
    bot.run(TOKEN)
